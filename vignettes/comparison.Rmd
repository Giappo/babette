---
title: "Comparison of using a fixed crown age or a calibration node"
author: "Richel J.C. Bilderbeek"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{Comparison of using a fixed crown age or a calibration node}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r create_files, include = FALSE}
file.copy(babette::get_babette_path("anthus_aco.fas"), "anthus_aco.fas")
```

This vignette compares two alternative ways to keep a posterior crown
age close to a certain value:

  1. Fix it at that crown age
  2. Add a calibration node, that includes all taxa, assumes monophyly,
     and has a narrow distribution around that crown age 

To setup, `babette` is loaded.

```{r}
library(babette)
```

To speed up calculations, a short MCMC chain is used.

```{r}
mcmc <- create_mcmc(chain_length = 10000, store_every = 1000)
```

Crown age and FASTA filename are set:

```{r}
crown_age <- 15
fasta_filename <- "anthus_aco.fas"
```

Run BEAST2 with a fixed crown age:

```{r cache=FALSE}
out_fca <- bbt_run(
  fasta_filename,
  posterior_crown_age = crown_age,
  mcmc = mcmc
)
```

Run BEAST2 with a MRCA prior around that crown age:

```{r cache=FALSE}
out_cn <- bbt_run(
  fasta_filename,
  mrca_priors = create_mrca_prior(
    alignment_id = get_alignment_id(fasta_filename),
    taxa_names = get_taxa_names(fasta_filename),
    mrca_distr = create_normal_distr(
      mean = crown_age,
      sigma = crown_age / 1000.0
    )
  ),
  mcmc = mcmc
)
```

Remove 20% burn-in from the data:

```{r}
traces_fca <- remove_burn_ins(
  traces = out_fca$estimates, 
  burn_in_fraction = 0.2
)
traces_cn <- remove_burn_ins(
  traces = out_cn$estimates, 
  burn_in_fraction = 0.2
)
```

Show the Effective Sample Sizes, to get an idea
of the inference strength:

```{r}
esses_fca <- calc_esses(
  traces = traces_fca, 
  sample_interval = 1000
)
esses_cn <- calc_esses(
  traces = traces_cn, 
  sample_interval = 1000
)
knitr::kable(t(esses_fca))
knitr::kable(t(esses_cn))
```

Show the summary statistics, to get an idea
of the parameter estimates:


```{r}
sum_stats_fca <- calc_summary_stats(
  traces = traces_fca, 
  sample_interval = 1000
)
sum_stats_cn <- calc_summary_stats(
  traces = traces_cn, 
  sample_interval = 1000
)
knitr::kable(t(sum_stats_fca))
knitr::kable(t(sum_stats_cn))
```

Plot the phylogenies:

```{r cache=FALSE, fig.width=7, fig.height=7}
plot_densitree(phylos = out_fca$anthus_aco_trees, alpha = 1, width = 1)
plot_densitree(phylos = out_cn$anthus_aco_trees, alpha = 1, width = 1)
```

```{r}
if ("bug" == "fixed") {
  nLTT::nltts_plot(out_fca$anthus_aco_trees, plot_nltts = TRUE, main = "Fixed crown age")
  nLTT::nltts_plot(out_cn$anthus_aco_trees, plot_nltts = TRUE, main = "Calibration node")
}
```

```{r cleanup, include = FALSE}
file.remove("anthus_aco.fas")
```
